language: android
sudo: required
os: linux
dist: trusty
before_cache:
- rm -fr $HOME/.gradle/caches/5.2.1
- rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
- rm -fr $HOME/.gradle/caches/*/plugin-resolution/
cache:
  npm: true
  directories:
  - $HOME/.gradle/caches/
  - $HOME/.gradle/wrapper/
  - $HOME/.android/build-cache
android:
  components:
  - tools
  - platform-tools
  - build-tools-28.0.3
  - android-28
  - android-$API
  - sys-img-$ABI-android-$API
  licenses:
  - 'android-sdk-preview-license-d099d938'
  - 'android-sdk-license-.+'
  - 'google-gdk-license-.+'
env:
  global:
  - ADB_INSTALL_TIMEOUT=8
  matrix:
  - API=28 ABI=x86         #

  - API=19 ABI=x86         #
  - API=19 ABI=armeabi-v7a #

  - API=16 ABI=x86         #
  - API=16 ABI=armeabi-v7a #

branches:
  only:
    - master

before_install:
# - android-update-sdk --components=sys-img-$ABI-android-$API --accept-licenses='android-sdk-license-[0-9a-f]{8}'
# - touch ~/.android/repositories.cfg
# - yes | sdkmanager "platforms;android-$API"
- nvm install 11
install:
- node ./travis_scripts/get-glide.js
- echo no | android create avd --force -n test -t android-$API --abi $ABI -c 100M
- emulator -avd test -no-accel -gpu auto -no-audio -no-window &
- android-wait-for-emulator
- adb shell input keyevent 82 &
before_script: chmod +x ./gradlew
script: ./gradlew connectedCheck
matrix:
  fast_finish: true
  allow_failures:
  - language: android
  include:
  - name: deploy
    env: API=28 ABI=x86_64
    before_install: nvm install 11
    install: node ./travis_scripts/get-glide.js
    before_script: chmod +x ./gradlew
    script: ./gradlew build
    before_deploy:
    - export TRAVIS_TAG=latest
    - node ./travis_scripts/deploy.js
    - chmod +x ./travis_scripts/appetize_url.sh
    - ./travis_scripts/appetize_url.sh
    - echo $APPETIZE_URL
    deploy:
      provider: releases
      api_key: $GITHUB_TOKEN
      file_glob: true
      file: "./app/build/outputs/apk/*/*.apk"
      skip_cleanup: true
      name: $(date +'%Y.%m.%d.%H:%M.%S')
      on:
        branch: master
    # - &test
    #   stage: testJDK
    #   jdk:
    #   - openjdk8
    # - <<: *test
# matrix:
#   include:
#     - jdk: openjdk8
#     - jdk: openjdk12
#       before_deploy:
#       - export TRAVIS_TAG=latest
#       - node ./travis_scripts/deploy.js
#       - chmod +x ./travis_scripts/appetize_url.sh
#       - ./travis_scripts/appetize_url.sh
#       - echo $APPETIZE_URL
#       deploy:
#         provider: releases
#         api_key: $GITHUB_TOKEN
#         file_glob: true
#         file: "./app/build/outputs/apk/*/*.apk"
#         skip_cleanup: true
#         name: $(date +'%Y.%m.%d.%H:%M.%S')
#         on:
#           branch: master

  # on:
    # condition: $TRAVIS_COMMIT_MESSAGE =~ ^(0|[1-9]\d*)\.(0|[1-9]\d*)\.(0|[1-9]\d*)(-(0|[1-9]\d*|\d*[a-zA-Z-][0-9a-zA-Z-]*)(\.(0|[1-9]\d*|\d*[a-zA-Z-][0-9a-zA-Z-]*))*)?(\+[0-9a-zA-Z-]+(\.[0-9a-zA-Z-]+)*)?$


